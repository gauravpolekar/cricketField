<!DOCTYPE html>
<html>
	<head>
		<script src="https://unpkg.com/konva@2.4.2/konva.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-touch-events/1.0.5/jquery.mobile-events.js"></script>
		<meta charset="utf-8" />
		<title>Cricket Field</title>
		<style>
			body {
				margin: 0;
				padding: 0;
				background-image: url('img/blankField.png');
				background-repeat: no-repeat;
				height: 100%;
				overflow: visible;
			}
			#container {
				height: 80%;
			}
		</style>
	</head>
	<body>
		<div id="container"></div>
		<script>
			var width = window.innerWidth;
			var height = window.innerHeight;
			var stage = new Konva.Stage({
				container: 'container',
				width: width,
				height: height
			});
			var layer = new Konva.Layer();
			// bound below y=50
			var getBluePlayerGroup = function (pageX, pageY) {
				return new Konva.Group({
					x: pageX,
					y: pageY,
					draggable: true,
					dragBoundFunc: function (pos) {
						var newY = pos.y < 50 ? 50 : pos.y;
						return {
							x: pos.x,
							y: newY
						};
					}
				});
			};
			// bound inside a circle
			var getYellowPlayerGroup = function (pageX, pageY) {
				return new Konva.Group({
					x: pageX,
					y: pageY,
					draggable: false,
					dragBoundFunc: function (pos) {
						var newY = pos.y < 50 ? 50 : pos.y;
						return {
							x: pos.x,
							y: newY
						};
					}
				});
			};

			var getTextNode = function (stageBox, value) {
				var textNode = new Konva.Text({
					fontSize: 12,
					fontFamily: 'Calibri',
					text: typeof value == 'string' ? value : 'Fielder' + value,
					fill: 'black',
					padding: 10
				});

				textNode.on('dblclick', () => {
					// create textarea over canvas with absolute position
					// first we need to find its positon
					var textPosition = textNode.getAbsolutePosition();
					var areaPosition = {
						x: textPosition.x + stageBox.left,
						y: textPosition.y + stageBox.top
					};
					// create text area and style it
					var textarea = document.createElement('textarea');
					document.body.appendChild(textarea);
					textarea.value = textNode.text();
					textarea.style.position = 'absolute';
					textarea.style.top = areaPosition.y + 'px';
					textarea.style.left = areaPosition.x + 'px';
					textarea.style.width = textNode.width();
					textarea.focus();
					textarea.addEventListener('keydown', function (e) {
						// hide on enter
						if (e.keyCode === 13) {
							textNode.text(textarea.value);
							layer.draw();
							document.body.removeChild(textarea);
						}
					});
				});
				return textNode;
			};
			var getBluePlayer = function (textNode) {
				return new Konva.Circle({
					width: textNode.getWidth(),
					height: textNode.getHeight(),
					radius: 10,
					fill: 'red',
					stroke: 'black',
					strokeWidth: 4
				});
			};
			var getYellowPlayer = function (textNode) {
				return new Konva.Circle({
					width: textNode.getWidth(),
					height: textNode.getHeight(),
					radius: 10,
					fill: 'yellow',
					stroke: 'black',
					strokeWidth: 4
				});
			};
			var blueGroup = getBluePlayerGroup(30, 70);
			var textNode = getTextNode(stage.getContainer().getBoundingClientRect());
			blueGroup.add(getBluePlayer(textNode)).add(textNode);

			//create WK
			var rectX_WK = 460;
			var rectY_WK = 280;
			var yellowGroup_WK = getYellowPlayerGroup(rectX_WK, rectY_WK);
			var textNode1_WK = getTextNode(stage.getContainer().getBoundingClientRect(), 'WK');

			//create Bowler
			var rectX_Bwl = 460;
			var rectY_Bwl = 580;
			var yellowGroup_Bwl = getYellowPlayerGroup(rectX_Bwl, rectY_Bwl);
			var textNode1_Bwl = getTextNode(stage.getContainer().getBoundingClientRect(), 'Bowler');

			yellowGroup_WK.add(getYellowPlayer(textNode1_WK)).add(textNode1_WK);
			yellowGroup_Bwl.add(getYellowPlayer(textNode1_Bwl)).add(textNode1_Bwl);
			//layer.add(blueGroup);
			layer.add(yellowGroup_WK);
			layer.add(yellowGroup_Bwl);
			// add the layer to the stage
			stage.add(layer);
			window.bluePlayerCount = 1;
			$('#container').on('click', function (e) {
				if (window.bluePlayerCount <= 9) {
					var playerGroup = getBluePlayerGroup(e.pageX, e.pageY);
					var text = getTextNode(
						stage.getContainer().getBoundingClientRect(),
						window.bluePlayerCount
					);
					playerGroup.add(getBluePlayer(text)).add(text);
					layer.add(playerGroup);
					stage.add(layer);
					window.bluePlayerCount++;
				}
			});
		</script>
	</body>
</html>
